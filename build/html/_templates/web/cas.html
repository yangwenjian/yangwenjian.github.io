

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cas &mdash; knight 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="knight 1.0.1 documentation" href="../../index.html" />
    <link rel="next" title="设计模式Head First" href="../programming/common/designpatterns.html" />
    <link rel="prev" title="Web Page Design" href="webpage.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../programming/common/designpatterns.html" title="设计模式Head First"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="webpage.html" title="Web Page Design"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">knight 1.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Cas</a><ul>
<li><a class="reference internal" href="#id1">Cas介绍</a><ul>
<li><a class="reference internal" href="#id2">相关概念</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3">Cas流程</a></li>
<li><a class="reference internal" href="#id4">最佳实践</a><ul>
<li><a class="reference internal" href="#springcas-client">Spring通过如下配置文件进行配置Cas Client:</a></li>
<li><a class="reference internal" href="#spring-cas-client">Spring cas client关键代码</a><ul>
<li><a class="reference internal" href="#org-springframework-security-web-access-exceptiontranslationfilter">org.springframework.security.web.access.ExceptionTranslationFilter:</a></li>
<li><a class="reference internal" href="#org-jasig-cas-client-validation-abstractticketvalidationfilter">org.jasig.cas.client.validation.AbstractTicketValidationFilter:</a></li>
<li><a class="reference internal" href="#org-springframework-security-web-authentication-abstractrauthenticationprocessingfilter">org.springframework.security.web.authentication.AbstractrAuthenticationProcessingFilter:</a></li>
<li><a class="reference internal" href="#org-springframework-security-web-authentication-simpleurlauthenticationsuccesshandler">org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler</a></li>
<li><a class="reference internal" href="#org-springframework-security-cas-userdetails-abstractcasassertionuserdetailsservice">org.springframework.security.cas.userdetails.AbstractCasAssertionUserDetailsService</a></li>
<li><a class="reference internal" href="#org-springframework-security-web-authentication-logout-logoutfilter">org.springframework.security.web.authentication.logout.LogoutFilter:</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id5">参考资料</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="webpage.html"
                        title="previous chapter">Web Page Design</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../programming/common/designpatterns.html"
                        title="next chapter">设计模式Head First</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/_templates/web/cas.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="cas">
<h1>Cas<a class="headerlink" href="#cas" title="Permalink to this headline">¶</a></h1>
<p>Central Authentication Service 是开源的单点登录解决方案。</p>
<div class="section" id="id1">
<h2>Cas介绍<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>支持的协议（Protocols）： Custom Protocol 、 CAS 、 OAuth 、 OpenID 、 RESTful API 、 SAML1.1 、 SAML2.0。</p>
<p>支持的认证机制：Active Directory 、 JAAS 、 JDBC 、 LDAP 、 X.509 Certificates。</p>
<p>安全策略：使用票据（Ticket）来实现支持的认证协议；</p>
<p>支持授权：可以决定哪些服务可以请求和验证服务票据（Service Ticket）；</p>
<p>提供高可用性：通过把认证过的状态数据存储在 TicketRegistry 组件中，这些组件有很多支持分布式环境的实现，
如： BerkleyDB 、 Default 、 EhcacheTicketRegistry 、 JDBCTicketRegistry 、 JBOSS TreeCache 、 JpaTicketRegistry 、 MemcacheTicketRegistry 等；</p>
<p>支持多种客户端： Java, .Net, PHP, Perl, Apache, uPortal 等。</p>
<div class="section" id="id2">
<h3>相关概念<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Credentials：用户提供的用于登录用的凭据信息，如用户名/密码、证书、IP地址、Cookie值等。比如UsernamePasswordCredentials，封装的是用户名和密码。
CAS进行认证的第一步，就是把从UI或request对象里取到的用户凭据封装成Credentials对象，然后交给认证管理器去认证；</p>
<p>AuthenticationHandler：认证Handler, 每种AuthenticationHandler只能处理一种Credentials；</p>
<p>Principal：封装用户标识，比如SimplePrincipal, 只是封装了用户名。认证成功后，credentialsToPrincipalResolvers负责由Credentials生成Principal对象；</p>
<p>CredentialsToPrincipalResolvers：负责由Credentials生成Principal对象，每种CredentialsToPrincipalResolvers 只处理一种Credentials，
比如UsernamePasswordCredentialsToPrincipalResolver负责从UsernamePasswordCredentials中取出用户名，然后将其赋给生成的SimplePrincipal的ID属性；</p>
<p>AuthenticationMetaDataPopulators：负责将Credentials的一些属性赋值给Authentication的attributes属性；</p>
<p>Authentication：Authentication是认证管理器的最终处理结果， Authentication封装了Principal，认证时间，及其他一些属性（可能来自Credentials）；</p>
<p>AuthenticationManager：认证管理器得到Credentials对象后，负责调度AuthenticationHandler去完成认证工作，最后返回的结果是Authentication对象；</p>
<p>CentralAuthenticationService：CAS的服务类，对Web层提供了一些方法。该类还负责调用AuthenticationManager完成认证逻辑；</p>
</div>
</div>
<div class="section" id="id3">
<h2>Cas流程<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Cas的访问流程分为几个步骤：</p>
<ol class="arabic simple">
<li>用户访问Cas保护的资源时，部署在客户Web应用的AuthenticationFilter，会截获此请求，生成service参数，然后redirect到CAS服务的login接口，
例如：<a class="reference external" href="https://casserverurl/cas/login?service=http://webserver/j_spring_cas_security_check">https://casserverurl/cas/login?service=http://webserver/j_spring_cas_security_check</a>；</li>
</ol>
<img alt="../../_images/cas_process1.jpg" src="../../_images/cas_process1.jpg" />
<ol class="arabic simple" start="2">
<li>用户与Cas Server进行交互，进行身份认证，认证成功后，CAS服务器会生成认证cookie，写入浏览器，同时将cookie缓存到服务器本地，
并为客户端浏览器设置一个 Ticket Granted Cookie（TGC），CAS 服务器还会根据service 参数生成ticket,ticket会保存到服务器，
也会加在url后面，然后将请求redirect回客户Web服务器，
例如：<a class="reference external" href="http://webserver/webapp/j_spring_cas_security_check?ticket=ST-0-ER94xMJmn6pha35CQRoZ">http://webserver/webapp/j_spring_cas_security_check?ticket=ST-0-ER94xMJmn6pha35CQRoZ</a>；</li>
</ol>
<img alt="../../_images/cas_process2.jpg" src="../../_images/cas_process2.jpg" />
<ol class="arabic simple" start="3">
<li>Web应用的CasAuthenticationFilter会监听上述请求，看到ticket参数后，会跳过，传给AuthenticationManager进行处理，也就是配置中的CasAuthenticationProvider，
由里面配置的的TicketValidationFilter处理，TicketValidationFilter会发送请求到Cas Server的/serviceValidate接口, 将ticket、service都传到此接口，
由此接口验证ticket的有效性，之后Cas Server会给出响应，如果成功的话响应中会包含UserName；</li>
</ol>
<img alt="../../_images/cas_process3.jpg" src="../../_images/cas_process3.jpg" />
<ol class="arabic simple" start="4">
<li>至此为止，SSO会话就建立起来了，以后用户在同一浏览器里访问此web应用时，AuthenticationFilter会在session里读取到用户信息，所以就不会去CAS认证，
如果在此浏览器里访问别的web 应用时，AuthenticationFilter在session 里读取不到用户信息，会去CAS 的login接口认证，但这时CAS会读取到浏览器传来的cookie，
所以CAS不会要求用户去登录页面登录，只是会根据service参数生成一个ticket ，然后再和web应用做一个验证ticket的交互而已；</li>
<li>Cas登出时，由requestSingleLogoutFilter访问/spring_security_cas_logout重定向到Cas Server来进行登出，再由Cas Server发送一个Single Logout Request到所有
注册的服务中，singleLogoutFilter处理这个Single Logout Request，从静态Map中查找Session并将其置为无效。</li>
</ol>
</div>
<div class="section" id="id4">
<h2>最佳实践<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>通过配置来实现自己的Handler</p>
<div class="section" id="springcas-client">
<h3>Spring通过如下配置文件进行配置Cas Client:<a class="headerlink" href="#springcas-client" title="Permalink to this headline">¶</a></h3>
<p>web.xml</p>
<div class="code highlight-python"><pre>&lt;!-- Wraps an HttpServletRequest so that the getRemoteUser and getPrincipal return the CAS related entries --&gt;
&lt;filter&gt;
    &lt;filter-name&gt;CAS HttpServletRequest Wrapper Filter&lt;/filter-name&gt;
    &lt;filter-class&gt;org.jasig.cas.client.util.HttpServletRequestWrapperFilter&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;!-- Places the Assertion in a ThreadLocal for portions of the application that need access to it. This is useful when the Web application
that this filter "fronts" needs to get the Principal name, but it has no access to the HttpServletRequest, hence making getRemoteUser() call impossible --&gt;
&lt;filter&gt;
    &lt;filter-name&gt;CAS Assertion Thread Local Filter&lt;/filter-name&gt;
    &lt;filter-class&gt;org.jasig.cas.client.util.AssertionThreadLocalFilter&lt;/filter-class&gt;
&lt;/filter&gt;</pre>
</div>
<p>spring-cas.xml</p>
<div class="code highlight-python"><pre>&lt;!-- 声明Cas认证切入点，并声明默认配置为false，以加入自己的定制 --&gt;
&lt;security:http entry-point-ref="casAuthenticationEntryPoint" auto-config="false"&gt;
    &lt;!-- 声明被保护的资源，注意顺序，并加入spring security的权限管理 --&gt;
    &lt;security:intercept-url pattern="/checkauthority.do" access="IS_AUTHENTICATED_ANONYMOUSLY" /&gt;
    &lt;security:intercept-url pattern="/\**/\*.cas" access="ROLE_USER,ROLE_DOCTOR" /&gt;

    &lt;!-- 如果声明默认配置为true，可以仅指定logout-success-url，其余都有默认初始值 --&gt;
    &lt;security:logout logout-success-url="${cas.securityContext.casProcessingFilterEntryPoint.logoutUrl}?service=${index.url}" /&gt; --&gt;
    &lt;security:custom-filter ref="concurrencyFilter" position="CONCURRENT_SESSION_FILTER" /&gt;
    &lt;security:custom-filter ref="casAuthenticationFilter" position="CAS_FILTER"/&gt;
    &lt;security:custom-filter ref="singleLogoutFilter" before="CAS_FILTER"/&gt;
    &lt;security:custom-filter ref="requestSingleLogoutFilter" position="LOGOUT_FILTER"/&gt;
&lt;/security:http&gt;

&lt;bean id="casAuthenticationEntryPoint" class="org.springframework.security.cas.web.CasAuthenticationEntryPoint"&gt;
    &lt;property name="loginUrl" value="${cas.securityContext.casProcessingFilterEntryPoint.loginUrl}"/&gt;
    &lt;property name="serviceProperties" ref="serviceProperties"&gt;&lt;/property&gt;
&lt;/bean&gt;

&lt;bean id="serviceProperties" class="org.springframework.security.cas.ServiceProperties"&gt;
    &lt;property name="service" value="${cas.securityContext.serviceProperties.service}" /&gt;
    &lt;property name="sendRenew" value="false" /&gt;
&lt;/bean&gt;

&lt;security:authentication-manager alias="authenticationManager"&gt;
    &lt;security:authentication-provider ref="casAuthenticationProvider"/&gt;
&lt;/security:authentication-manager&gt;

&lt;bean id="casAuthenticationProvider" class="org.springframework.security.cas.authentication.CasAuthenticationProvider"&gt;
    &lt;property name="authenticationUserDetailsService" ref="authenticationUserDetailsService" /&gt;
    &lt;property name="serviceProperties" ref="serviceProperties"&gt;&lt;/property&gt;
    &lt;property name="ticketValidator"&gt;
        &lt;!-- Validates the tickets using the CAS 2.0 protocol. If you provide either the acceptAnyProxy or the allowedProxyChains parameters,
        a Cas20ProxyTicketValidator will be constructed. Otherwise a general Cas20ServiceTicketValidator will be constructed that does not accept proxy tickets --&gt;
        &lt;bean class="org.jasig.cas.client.validation.Cas20ServiceTicketValidator"&gt;
            &lt;constructor-arg index="0" value="${cas.securityContext.ticketValidator.casServerUrlPrefix}"&gt;&lt;/constructor-arg&gt;
        &lt;/bean&gt;
    &lt;/property&gt;
    &lt;property name="key" value="an_id_for_this_auth_provider_only"&gt;&lt;/property&gt;
&lt;/bean&gt;

&lt;bean id="casAuthenticationFilter" class="org.springframework.security.cas.web.CasAuthenticationFilter"&gt;
    &lt;property name="authenticationManager" ref="authenticationManager"/&gt;
    &lt;property name="authenticationSuccessHandler" ref="authenticationSuccessHandler"/&gt;
&lt;/bean&gt;

&lt;bean id="authenticationSuccessHandler" class="com.xikang.ch.cas.MyAuthenticationSuccessHandler"&gt;
    &lt;property name="alwaysUseDefaultTargetUrl" value="true" /&gt;
    &lt;property name="defaultTargetUrl" value="${index.url}" /&gt;
    &lt;property name="serverName" value="${ch.domain}" /&gt;
&lt;/bean&gt;

&lt;bean id="concurrencyFilter" class="org.springframework.security.web.session.ConcurrentSessionFilter"&gt;
    &lt;property name="sessionRegistry" ref="sessionRegistry" /&gt;
    &lt;property name="expiredUrl" value="${cas.securityContext.casProcessingFilterEntryPoint.logoutUrl}" /&gt;
&lt;/bean&gt;

&lt;bean id="sessionRegistry" class="org.springframework.security.core.session.SessionRegistryImpl" /&gt;

&lt;bean id="authenticationUserDetailsService" class="com.xikang.ch.cas.GrantedAuthorityFromAssertionAttributesXKUserDetailsService"&gt;
    &lt;constructor-arg&gt;
        &lt;array&gt;
            &lt;value&gt;authorities&lt;/value&gt;
        &lt;/array&gt;
    &lt;/constructor-arg&gt;
&lt;/bean&gt;
&lt;bean id="proxyGrantingTicketStorage" class="org.jasig.cas.client.proxy.ProxyGrantingTicketStorageImpl" /&gt;

&lt;!--登出配置--&gt;

&lt;bean id="singleLogoutFilter" class="org.jasig.cas.client.session.SingleSignOutFilter"/&gt;

&lt;bean id="requestSingleLogoutFilter" class="org.springframework.security.web.authentication.logout.LogoutFilter"&gt;
    &lt;constructor-arg value="${cas.securityContext.casProcessingFilterEntryPoint.logoutUrl}" /&gt;
    &lt;constructor-arg&gt;
        &lt;!-- &lt;bean class="org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler" /&gt; --&gt;
        &lt;bean class="com.xikang.cn.cas.MySecrityContextLogouthandler"/&gt;
    &lt;/constructor-arg&gt;
    &lt;property name="filterProcessesUrl" value="/j_spring_security_logout" /&gt;
&lt;/bean&gt;</pre>
</div>
</div>
<div class="section" id="spring-cas-client">
<h3>Spring cas client关键代码<a class="headerlink" href="#spring-cas-client" title="Permalink to this headline">¶</a></h3>
<p>当用户访问一个被SpringSecurity保护的资源时，会抛出AccessDeniedException或者AuthenticationException，
就会被ExceptionTranslationFilter类探测并解惑；</p>
<div class="section" id="org-springframework-security-web-access-exceptiontranslationfilter">
<h4>org.springframework.security.web.access.ExceptionTranslationFilter:<a class="headerlink" href="#org-springframework-security-web-access-exceptiontranslationfilter" title="Permalink to this headline">¶</a></h4>
<div class="code java highlight-python"><pre>public class ExceptionTranslationFilter extends GenericFilterBean {

    private AccessDeniedHandler accessDeniedHandler = new AccessDeniedHandlerImpl();
    //认证的切面入口点，这里是casAuthenticationEntryPoint
    private AuthenticationEntryPoint authenticationEntryPoint;
    private AuthenticationTrustResolver authenticationTrustResolver = new AuthenticationTrustResolverImpl();
    private ThrowableAnalyzer throwableAnalyzer = new DefaultThrowableAnalyzer();
    private RequestCache requestCache = new HttpSessionRequestCache();

    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) req;
        HttpServletResponse response = (HttpServletResponse) res;
        try{
            chain.doFilter(request, response);
            logger.debug("Chain processed normally");
        }catch (IOException ex) {
            throw ex;
        }catch (Exception ex) {
            // Try to extract a SpringSecurityException from the stacktrace
            Throwable[] causeChain = throwableAnalyzer.determineCauseChain(ex);
            RuntimeException ase = (AuthenticationException) throwableAnalyzer.getFirstThrowableOfType(AuthenticationException.class, causeChain);
            if (ase == null) {
                ase = (AccessDeniedException)throwableAnalyzer.getFirstThrowableOfType(AccessDeniedException.class, causeChain);
            }
            if (ase != null) {
                handleSpringSecurityException(request, response, chain, ase);
            }else {
                // Rethrow ServletExceptions and RuntimeExceptions as-is
                if (ex instanceof ServletException) {
                    throw (ServletException) ex;
                }else if (ex instanceof RuntimeException) {
                    throw (RuntimeException) ex;
                }
                // Wrap other Exceptions. This shouldn't actually happen
                // as we've already covered all the possibilities for doFilter''
                throw new RuntimeException(ex);
            }
        }
    }
    private void handleSpringSecurityException(HttpServletRequest request, HttpServletResponse response, FilterChain chain,
            RuntimeException exception) throws IOException, ServletException {
        if (exception instanceof AuthenticationException) {
            logger.debug("Authentication exception occurred; redirecting to authentication entry point", exception);
            sendStartAuthentication(request, response, chain, (AuthenticationException) exception);
        }else if (exception instanceof AccessDeniedException) {
            if (authenticationTrustResolver.isAnonymous(SecurityContextHolder.getContext().getAuthentication())) {
                logger.debug("Access is denied (user is anonymous); redirecting to authentication entry point", exception);
                sendStartAuthentication(request, response, chain, new InsufficientAuthenticationException(
                                        "Full authentication is required to access this resource"));
            } else {
                logger.debug("Access is denied (user is not anonymous); delegating to AccessDeniedHandler", exception);
                accessDeniedHandler.handle(request, response, (AccessDeniedException) exception);
            }
        }
    }
    protected void sendStartAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain,
            AuthenticationException reason) throws ServletException, IOException {
        SecurityContextHolder.getContext().setAuthentication(null);
        requestCache.saveRequest(request, response);
        logger.debug("Calling Authentication entry point.");
        //这里根据authenticationEntryPoint的具体类型重定向到其中的认证页面
        authenticationEntryPoint.commence(request, response, reason);
    }
}</pre>
</div>
<p>Cas Client通过TicketValidationFilter来验证ticket的有效性；</p>
</div>
<div class="section" id="org-jasig-cas-client-validation-abstractticketvalidationfilter">
<h4>org.jasig.cas.client.validation.AbstractTicketValidationFilter:<a class="headerlink" href="#org-jasig-cas-client-validation-abstractticketvalidationfilter" title="Permalink to this headline">¶</a></h4>
<div class="code java highlight-python"><pre>public final void doFilter(final ServletRequest servletRequest, final ServletResponse servletResponse,
   final FilterChain filterChain) throws IOException, ServletException {
   if (!preFilter(servletRequest, servletResponse, filterChain)) {
       return;
   }
   final HttpServletRequest request = (HttpServletRequest) servletRequest;
   final HttpServletResponse response = (HttpServletResponse) servletResponse;
   final String ticket = CommonUtils.safeGetParameter(request, getArtifactParameterName());
   if (CommonUtils.isNotBlank(ticket)) {
       if (log.isDebugEnabled()) {
           log.debug("Attempting to validate ticket: " + ticket);
       }
       try{
           final Assertion assertion = this.ticketValidator.validate(ticket, constructServiceUrl(request, response));
           if (log.isDebugEnabled()) {
               log.debug("Successfully authenticated user: " + assertion.getPrincipal().getName());
           }
           request.setAttribute(CONST_CAS_ASSERTION, assertion);
           if (this.useSession) {
               request.getSession().setAttribute(CONST_CAS_ASSERTION, assertion);
           }
           onSuccessfulValidation(request, response, assertion);
       }catch (final TicketValidationException e) {
           response.setStatus(HttpServletResponse.SC_FORBIDDEN);
           log.warn(e, e);
           onFailedValidation(request, response);
           if (this.exceptionOnValidationFailure) {
               throw new ServletException(e);
           }
       }
       if (this.redirectAfterValidation) {
           log. debug("Redirecting after successful ticket validation.");
           response.sendRedirect(response.encodeRedirectURL(constructServiceUrl(request, response)));
           return;
       }
   }
   filterChain.doFilter(request, response);
}</pre>
</div>
<p>Cas Client通过CasAuthenticationFilter来监听/j_spring_cas_security_check的请求，进行认证后的filter工作；</p>
</div>
<div class="section" id="org-springframework-security-web-authentication-abstractrauthenticationprocessingfilter">
<h4>org.springframework.security.web.authentication.AbstractrAuthenticationProcessingFilter:<a class="headerlink" href="#org-springframework-security-web-authentication-abstractrauthenticationprocessingfilter" title="Permalink to this headline">¶</a></h4>
<div class="code java highlight-python"><pre>public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException {
    HttpServletRequest request = (HttpServletRequest) req;
    HttpServletResponse response = (HttpServletResponse) res;
    if (!requiresAuthentication(request, response)) {
        chain.doFilter(request, response);
        return;
    }
    if (logger.isDebugEnabled()) {
        logger.debug("Request is to process authentication");
    }
    Authentication authResult;
    try {
        authResult = attemptAuthentication(request, response);
        if (authResult == null) {
            // return immediately as subclass has indica ted that it hasn't completed authentication
            return;
        }
        sessionStrategy.onAuthentication(authResult, request, response);
    }catch(InternalAuthenticationServiceException failed) {
        logger.error("An internal error occurred while trying to authenticate the user.", failed);
        unsuccessfulAuthentication(request, response, failed);
        return;
    }catch (AuthenticationException failed) {
        unsuccessfulAuthentication(request, response, failed);
        return;
    }
    //Authentication success
    if (continueChainBeforeSuccessfulAuthentication) {
        chain.doFilter(request, response);
    }

    successfulAuthentication(request, response, chain, authResult);
}

protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain,
            Authentication authResult) throws IOException, ServletException{
    successfulAuthentication(request, response, authResult);
}

@Deprecated
protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response,
        Authentication authResult) throws IOException, ServletException {
    if (logger.isDebugEnabled()) {
        logger.debug("Authentication success. Updating SecurityContextHolder to contain: " + authResult);
    }
    SecurityContextHolder.getContext().setAuthentication(authResult);
    rememberMeServices.loginSuccess(request, response, authResult);
    if (this.eventPublisher != null) {
        eventPublisher.publishEvent(new InteractiveAuthenticationSuccessEvent(authResult, this.getClass()));
    }
    successHandler.onAuthenticationSuccess(request, response, authResult);
}</pre>
</div>
<p>通过继承SimpleUrlAuthenticationSuccessHandler来实现自己的登录后逻辑；</p>
</div>
<div class="section" id="org-springframework-security-web-authentication-simpleurlauthenticationsuccesshandler">
<h4>org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler<a class="headerlink" href="#org-springframework-security-web-authentication-simpleurlauthenticationsuccesshandler" title="Permalink to this headline">¶</a></h4>
<div class="code java highlight-python"><pre>public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
        Authentication authentication) throws IOException, ServletException {
    handle(request, response, authentication);
    clearAuthenticationAttributes(request);
}

protected final void clearAuthenticationAttributes(HttpServletRequest request) {
    HttpSession session = request.getSession(false);
    if(session == null){
        return;
    }
    session.removeAttribute(WebAttributes.AUTHENTICATION_EXCEPTION);
}

//父类方法
protected void handle(HttpServletRequest request, HttpServletResponse response, Authentication authentication)
        throws IOException, ServletException {
    String targetUrl = determineTargetUrl(request, response);
    if (response.isCommitted()) {
        logger.debug("Response has already been committed. Unable to redirect to " + targetUrl);
        return;
    }
    redirectStrategy.sendRedirect(request, response, targetUrl);
}</pre>
</div>
<p>通过继承AbstractCasAssertionUserDetailsService来实现用户权限分配；</p>
</div>
<div class="section" id="org-springframework-security-cas-userdetails-abstractcasassertionuserdetailsservice">
<h4>org.springframework.security.cas.userdetails.AbstractCasAssertionUserDetailsService<a class="headerlink" href="#org-springframework-security-cas-userdetails-abstractcasassertionuserdetailsservice" title="Permalink to this headline">¶</a></h4>
<div class="code java highlight-python"><pre>//认证成功后回调，返回用户Code的方法
public abstract class AbstractCasAssertionUserDetailsService implements AuthenticationUserDetailsService{
    public final UserDetails loadUserDetails(final Authentication token) throws UsernameNotFoundException {
        Assert.isInstanceOf(CasAssertionAuthenticationToken.class, token, "The provided token MUST be an instance of CasAssertionAuthenticationToken.class");
        return loadUserDetails(((CasAssertionAuthenticationToken) token).getAssertion());
    }
}
//空方法，需要继承实现，来编写自己的逻辑
protected abstract UserDetails loadUserDetails(Assertion assertion);</pre>
</div>
<p>通过继承SecurityContextLogoutHandler并注入到LogoutFilter来实现自己的用户登出逻辑，这里可以使用多个Handler；</p>
</div>
<div class="section" id="org-springframework-security-web-authentication-logout-logoutfilter">
<h4>org.springframework.security.web.authentication.logout.LogoutFilter:<a class="headerlink" href="#org-springframework-security-web-authentication-logout-logoutfilter" title="Permalink to this headline">¶</a></h4>
<div class="code java highlight-python"><pre>public LogoutFilter(String logoutSuccessUrl, LogoutHandler... handlers) {
    Assert.notEmpty(handlers, "LogoutHandlers are required");
    this.handlers = Arrays.asList(handlers);
    Assert.isTrue(!StringUtils.hasLength(logoutSuccessUrl) || UrlUtils.isValidRedirectUrl(logoutSuccessUrl), logoutSuccessUrl + " isn't a valid redirect URL");
    SimpleUrlLogoutSuccessHandler urlLogoutSuccessHandler = new SimpleUrlLogoutSuccessHandler();
    if (StringUtils.hasText(logoutSuccessUrl)) {
        urlLogoutSuccessHandler.setDefaultTargetUrl(logoutSuccessUrl);
    }
    logoutSuccessHandler = urlLogoutSuccessHandler;
    setFilterProcessesUrl("/j_spring_security_logout");
}
public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException {
    HttpServletRequest request = (HttpServletRequest) req;
    HttpServletResponse response = (HttpServletResponse) res;
    if (requiresLogout(request, response)) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        if (logger.isDebugEnabled()) {
            logger.debug("Logging out user '" + auth + "' and transferring to logout destination");
        }
        for (LogoutHandler handler : handlers) {
            handler.logout(request, response, auth);
        }
        logoutSuccessHandler.onLogoutSuccess(request, response, auth);
        return;
    }
    chain.doFilter(request, response);
}</pre>
</div>
</div>
</div>
</div>
<div class="section" id="id5">
<h2>参考资料<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.1.6.RELEASE/reference/cas.html">http://docs.spring.io/spring-security/site/docs/3.1.6.RELEASE/reference/cas.html</a></p>
<p><a class="reference external" href="https://www.ibm.com/developerworks/cn/opensource/os-cn-cas/">https://www.ibm.com/developerworks/cn/opensource/os-cn-cas/</a></p>
<p><a class="reference external" href="http://blog.csdn.net/dongdong_java/article/details/22293377">http://blog.csdn.net/dongdong_java/article/details/22293377</a></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../programming/common/designpatterns.html" title="设计模式Head First"
             >next</a> |</li>
        <li class="right" >
          <a href="webpage.html" title="Web Page Design"
             >previous</a> |</li>
        <li><a href="../../index.html">knight 1.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, knight.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>