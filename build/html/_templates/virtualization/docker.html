

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Docker &mdash; cloudlight 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="cloudlight 1.0.1 documentation" href="../../index.html" />
    <link rel="next" title="Hadoop介绍及基础研究" href="../distribution/hadoop.html" />
    <link rel="prev" title="Energy Saving Plan–Valithria" href="../automation/energy_saving_plan.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../distribution/hadoop.html" title="Hadoop介绍及基础研究"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../automation/energy_saving_plan.html" title="Energy Saving Plan–Valithria"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">cloudlight 1.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Docker</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#docker-design">Docker Design</a><ul>
<li><a class="reference internal" href="#the-docker-daemon">The Docker Daemon</a></li>
<li><a class="reference internal" href="#the-docker-client">The Docker client</a></li>
<li><a class="reference internal" href="#inside-docker">Inside Docker</a><ul>
<li><a class="reference internal" href="#docker-images">Docker Images</a></li>
<li><a class="reference internal" href="#docker-registries">Docker Registries</a></li>
<li><a class="reference internal" href="#docker-containers">Docker Containers</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#the-underlying-technology">The Underlying Technology</a><ul>
<li><a class="reference internal" href="#namespace">Namespace</a></li>
<li><a class="reference internal" href="#control-groups">Control Groups</a></li>
<li><a class="reference internal" href="#union-file-system">Union File System</a></li>
<li><a class="reference internal" href="#container-format">Container Format</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exersice">Exersice</a><ul>
<li><a class="reference internal" href="#id1">Docker实践</a></li>
<li><a class="reference internal" href="#id2">Docker容器调优</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3">Docker参考手册</a><ul>
<li><a class="reference internal" href="#using-docker">Using Docker</a></li>
<li><a class="reference internal" href="#docker-tomcat">Docker 开机自启动tomcat服务</a></li>
<li><a class="reference internal" href="#reference">reference</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../automation/energy_saving_plan.html"
                        title="previous chapter">Energy Saving Plan&#8211;Valithria</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../distribution/hadoop.html"
                        title="next chapter">Hadoop介绍及基础研究</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/_templates/virtualization/docker.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="docker">
<h1>Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h1>
<p>Docker is a virtualization tool Based on Linux Container(LXC).
Useful and easy-to-use.</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Docker is application container, to some extent, like virtual machines.
But there are a lot of differences:</p>
<ul class="simple">
<li>Virtualization is based on physical cpu and memory, while docker is based on OS, using containerization technique, even running on virtual machine.</li>
<li>Virtualization refers to system image, called &#8216;system&#8217;, while docker is called &#8216;container&#8217;, which is more suitable for light application, such as redis, or memcached.</li>
<li>Virtualization uses snapshot to save the state. Docker is lower cost and protable. Docker imports code version control, which is more easy to switch between versions.</li>
<li>Virtualization is more complex at building system. Docker uses dockerfile to build containers, which is faster. Dockerfile can access on the host, which is more convenient.</li>
</ul>
<p>Docker&#8217;s features:</p>
<ul class="simple">
<li>File system isolation.</li>
<li>Resource isolation, like cpu and memory.</li>
<li>Network isolation: every container has its own network interface and ip.</li>
<li>Writing copy: makes deploy faster, save more disk space and memory space.</li>
<li>Log system.</li>
<li>Change management.</li>
<li>Interactive shell.</li>
</ul>
</div>
<div class="section" id="docker-design">
<h2>Docker Design<a class="headerlink" href="#docker-design" title="Permalink to this headline">¶</a></h2>
<p>Docker uses a client-server architecture.
The docker client and daemon communicate via sockets or through restful api.</p>
<div class="section" id="the-docker-daemon">
<h3>The Docker Daemon<a class="headerlink" href="#the-docker-daemon" title="Permalink to this headline">¶</a></h3>
<p>The docker daemon runs on a host machine. The user does not directly interact with the daemon, but instead through the Docker client.</p>
</div>
<div class="section" id="the-docker-client">
<h3>The Docker client<a class="headerlink" href="#the-docker-client" title="Permalink to this headline">¶</a></h3>
<p>The Docker client, in the form of the docker binary, is the primary user interface to Docker.
It accepts commands from the user and communicates back and forth with a Docker daemon.</p>
</div>
<div class="section" id="inside-docker">
<h3>Inside Docker<a class="headerlink" href="#inside-docker" title="Permalink to this headline">¶</a></h3>
<p>Docker contains these parts:</p>
<ol class="arabic simple">
<li>Docker images. Docker images are the build components of docker. It can easily created, downloaded, updated.</li>
<li>Docker registries. Docker registries hold images, like public or private stores.</li>
<li>Docker containers. Docker containers are the run compontes of docker, like directory, but are isolated and secure application platform.</li>
</ol>
<div class="section" id="docker-images">
<h4>Docker Images<a class="headerlink" href="#docker-images" title="Permalink to this headline">¶</a></h4>
<p>Each docker images consists of a series of layes.
Docker makes use of union file system to combine these layers into a single image.
Union file systems allow files and directories of separate file system, known as branches, to be transparently overlaid, forming a single coherent file system.</p>
<p>One of the reasons docker is so lightweight is because of these layers. When we change a docker image&#8211;for example, update an application to a new version&#8211;a new layer was built.
With only that layer built, docker is faster than virtual machines.</p>
</div>
<div class="section" id="docker-registries">
<h4>Docker Registries<a class="headerlink" href="#docker-registries" title="Permalink to this headline">¶</a></h4>
<p>Docker Hub provides both public and private storage for images. Public storage is searchable and can be downloaded by anyone. Private storage is excluded from search results and only you and your users can pull images down and use them to build containers.</p>
</div>
<div class="section" id="docker-containers">
<h4>Docker Containers<a class="headerlink" href="#docker-containers" title="Permalink to this headline">¶</a></h4>
<p>A container consists of an operating system, user-added files, and meta-data.
When we run <em>docker run -i -t ubuntu /bin/bash</em> , docker does the following:</p>
<div class="highlight-python"><pre>1) pulls the ubuntu image;
2) create a new container;
3) Allocate a file system and mounts a read-write layer;
4) Allocate a network/bridge interface, allowing docker containers talk to the host;
5) Sets up an IP address;
6) Excutes a process that you specify;
7) Captures and provides application output.</pre>
</div>
</div>
</div>
</div>
<div class="section" id="the-underlying-technology">
<h2>The Underlying Technology<a class="headerlink" href="#the-underlying-technology" title="Permalink to this headline">¶</a></h2>
<p>Docker is written in Go and makes use of serveral Linux kernel features to deliver the functionality we have seen.</p>
<div class="section" id="namespace">
<h3>Namespace<a class="headerlink" href="#namespace" title="Permalink to this headline">¶</a></h3>
<p>Docker use namespace to isolate the workspace.</p>
<p>Some of the namespaces that docker uses are:</p>
<div class="highlight-python"><pre>1) The pid namespace: used for process isolation;
2) The net namespace: used for managing network interfaces;
3) The ipc namespace: used for managing access to IPC resources;
4) The mnt namespace: used for managing mounting point;
5) The uts namespace: used for isolating kernel and version identifiers.</pre>
</div>
</div>
<div class="section" id="control-groups">
<h3>Control Groups<a class="headerlink" href="#control-groups" title="Permalink to this headline">¶</a></h3>
<p>Control groups allow Docker to share available hardware resources to containers and, if required, set up limits and constraints.
For example, limiting the memory available to a specific container.</p>
</div>
<div class="section" id="union-file-system">
<h3>Union File System<a class="headerlink" href="#union-file-system" title="Permalink to this headline">¶</a></h3>
<p>Docker can make use of several union file system variants including: AUFS, btrfs, vfs, and DeviceMapper.</p>
</div>
<div class="section" id="container-format">
<h3>Container Format<a class="headerlink" href="#container-format" title="Permalink to this headline">¶</a></h3>
<p>Docker combines these components into a wrapper we call a container format. The default container format is called libcontainer.
Docker also supports traditional Linux containers using LXC.
In the future, Docker may support other container formats, for example, by integrating with BSD Jails or Solaris Zones</p>
</div>
</div>
<div class="section" id="exersice">
<h2>Exersice<a class="headerlink" href="#exersice" title="Permalink to this headline">¶</a></h2>
<p>今天将base层接口迁移到新的更大的openstack环境中，这个环境下，所有的endpoint都是用主机名表示的，这样的好处是便于维护和区分各个主机的作用。</p>
<p>但引发一个问题，base层是部在dokcer容器中，docker不支持/etc/hosts主机名解析，这个文件根本就是readonly的。于是我请教我的同事。
可以在docker启动的时候加入参数</p>
<div class="highlight-python"><pre>docker start DOCKER_ID -v /etc/hosts:/etc/hosts:ro</pre>
</div>
<p>今天（2014.09.17）Docker1.2版本发布，支持/etc/hosts文件解析主机名IP，这正好满足了我今天的需求。
由于ubuntu官方的源daocker不是最新版的，只能将docker官方源加入到源中：</p>
<div class="highlight-python"><pre>echo deb https://get.docker.io/ubuntu docker main &gt; /etc/apt/sources.list.d/docker.list</pre>
</div>
<p>重新安装后，docker进程重新启动，所有的容器都停止了（之前应该做些备份处理的）。</p>
<p>这里有个小插曲：</p>
<p>Docker每次重启的时候都会DHCP一个新的IP，这次升级后它的ssh私钥发生了变化，原来的免密码登陆失效了，而且直接报错。
这里是这样的，ssh在连接的时候将server端的public key保存到本地的~/.ssh/know_hosts文件中，只要删除这个文件中的相应内容，就可以重新密码连接了。</p>
<p>其实完全可以用其他工具进行连接容器，这里推荐使用nsenter，轻量级连接docker工具，简单易用。
安装（这里暂不推荐最新版2.25,编译的时候有问题，没解决）：</p>
<div class="highlight-python"><pre>curl https://www.kernel.org/pub/linux/utils/util-linux/v2.24/util-linux-2.24.tar.gz | tar -zxf-
cd ../util-linux-2.24/
./configure --without-ncurses
make nsenter
cp nsenter /usr/local/bin
docker ps -a
PID=$(docker inspect --format '{{.State.Pid}}' bfcd9910faee)
nsenter --target $PID --mount --uts --ipc --net --pid</pre>
</div>
<p>之后就跟ssh上去一样，可以操作容器了。</p>
<div class="section" id="id1">
<h3>Docker实践<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>今天base和portal第一个版本发布，我将部署docker容器作为发布的运行容器。
第一次写dockerfile，参考了同事的资料：</p>
<div class="highlight-python"><pre>FROM ubuntu
MAINTAINER yangwenjian &lt;yangwj@neunn.com&gt;

RUN apt-get update
ADD tomcat7 /usr/local/
ADD jdk1.7.0_55 /usr/lib/
ADD profile /etc/
EXPOSE 8888 22</pre>
</div>
<p>build后产生新的镜像，结果怎么run这个镜像也跑不起来，直接镜像就推出，通过docker logs也看不出什么。</p>
<p>运行我镜像列表的里的所有镜像，发现都是同一个毛病，求助于同事，同事查看了一通后也没发现明显的问题。他只是觉得镜像有问题，最后发现是我在构建的时候下载镜像的过程中断网了，结果镜像没有下去，有问题，当时就被公司的网络耍了一把。</p>
<p>用了新的镜像后发现docker file有些内容没有写进去，profile是写进去了，但是tomcat和jdk都没有进入文件系统中，其实是我的dockerfile写法有问题，ADD添加文件夹的时候和我们观念上的添加文件夹不同，需要给文件夹指定名称。正确的写法如下：</p>
<div class="highlight-python"><pre>#his is a docker file to create container for base/portal deployment
FROM ubuntu:neunn
MAINTAINER yangwenjian &lt;yangwj@neunn.com&gt;

RUN apt-get update
ADD tomcat7/ /usr/local/tomcat7
ADD jdk1.7.0_55/ /usr/lib/jdk1.7.0_55
ADD profile /etc/
EXPOSE 8888 22</pre>
</div>
<p>这里启动后会自动加载/etc/profile文件，就想linux系统启动一样。</p>
<p>某天突然停电，重新启动服务器后，再启动所有docker容器，发现base层服务出现连接超时！
原因是docker容器再重新启动后会覆写/etc/hosts文件，之前加的host与IP的对应表都消失了！
这是docker的一种特性吧，这里推荐在启动时加入-v挂载本地文件到docker容器中，这样就会永久生效。</p>
</div>
<div class="section" id="id2">
<h3>Docker容器调优<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>我先抛出问题，我们Base组利用docker进行部署几个服务，包括Base服务，NeunnManager服务，NeunnPortal服务，但是问题是经常发现docker中的tomcat无缘无故的自动退出，当然，这里也有OutOfMemory和OutOfPermgenSpace，但是这两个问题可以通过Tomcat参数调优进行解决，也可以进行Docker的参数调优。</p>
<p>但是自动退出这个问题，由于没有合适的监控，没有任何日志信息，这里没有任何解决办法，目前的策略是将每个服务进行彻底分离，并将Bamboo的Agent与服务部署的容器进行分离，避免相互干扰。</p>
</div>
</div>
<div class="section" id="id3">
<h2>Docker参考手册<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>这里填写一些命令参考，供翻阅。</p>
<div class="section" id="using-docker">
<h3>Using Docker<a class="headerlink" href="#using-docker" title="Permalink to this headline">¶</a></h3>
<p>Install docker on OpenSuse:</p>
<div class="highlight-python"><pre>$sudo zypper ar -f http://download.opensuse.org/repositories/Virtualization/openSUSE_13.1/ Virtualization
$sudo rpm --import http://download.opensuse.org/repositories/Virtualization/openSUSE_13.1/repodata/repomd.xml.key
$ssudo zypper in docker
$sudo systemctl start docker
$sudo systemctl enable docker(optional)</pre>
</div>
<p>Run docker:</p>
<div class="highlight-python"><pre>$sudo docker run [option] [imagename] [command]
$sudo docker run -t -i ubuntu:14.04 /bin/bash (-t means create a terminal, -i means we can interact with stdin)
$sudo docker run -d ubuntu:14.04 /bin/bash (-d means run in deamon process)
$sudo docker run -t -i -p localhost:8080:80 ubuntu:14.04 /bin/bash(port mapping the container 80 port to host 8080 port)</pre>
</div>
<p>Usual command:</p>
<div class="highlight-python"><pre>Commands:
   attach    Attach to a running container
   build     Build an image from a Dockerfile
   commit    Create a new image from a container's changes
   cp        Copy files/folders from a container's filesystem to the host path
   diff      Inspect changes on a container's filesystem
   events    Get real time events from the server
   export    Stream the contents of a container as a tar archive
   history   Show the history of an image
   images    List images
   import    Create a new filesystem image from the contents of a tarball
   info      Display system-wide information
   inspect   Return low-level information on a container
   kill      Kill a running container
   load      Load an image from a tar archive
   login     Register or log in to the Docker registry server
   logs      Fetch the logs of a container
   port      Lookup the public-facing port that is NAT-ed to PRIVATE_PORT
   pause     Pause all processes within a container
   ps        List containers
   pull      Pull an image or a repository from a Docker registry server
   push      Push an image or a repository to a Docker registry server
   restart   Restart a running container
   rm        Remove one or more containers
   rmi       Remove one or more images
   run       Run a command in a new container
   save      Save an image to a tar archive
   search    Search for an image on the Docker Hub
   start     Start a stopped container
   stop      Stop a running container
   tag       Tag an image into a repository
   top       Lookup the running processes of a container
   unpause   Unpause a paused container
   version   Show the Docker version information
   wait      Block until a container stops, then print its exit code</pre>
</div>
<p>Example:</p>
<div class="highlight-python"><pre>$docker ps -a
$docker start [containerId]
$docker attach [containerId]
$docker stop [containerId]
$docker logs [containerId]
$docker commit [containerId] name/imagename:versionId</pre>
</div>
<p>NAT with iptables:</p>
<div class="highlight-python"><pre>iptables -t nat -A  DOCKER -p tcp --dport   &lt;local port&gt; -j DNAT --to-destination &lt;docker ip&gt;:&lt;docker port&gt;</pre>
</div>
</div>
<div class="section" id="docker-tomcat">
<h3>Docker 开机自启动tomcat服务<a class="headerlink" href="#docker-tomcat" title="Permalink to this headline">¶</a></h3>
<p>这里的镜像是从tumtu下载的带有ssh服务的ubuntu镜像，他的dockerfile如下：</p>
<div class="highlight-python"><pre>FROM ubuntu:latest
MAINTAINER Knight/basic:0.1&lt;yangwj@neunn.com&gt;

# Install packages
RUN apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get -y install openssh-server pwgen
RUN mkdir -p /var/run/sshd &amp;&amp; sed -i "s/UsePrivilegeSeparation.*/UsePrivilegeSeparation no/g" /etc/ssh/sshd_config &amp;&amp; sed -i "s/UsePAM.*/UsePAM no/g" /etc/ssh/sshd_config &amp;&amp; sed -i "s/PermitRootLogin.*/PermitRootLogin yes/g" /etc/ssh/sshd_config
ADD jdk1.7.0_55 /usr/lib/jdk1.7.0_55
ADD tomcat7 /usr/local/tomcat7
ADD profile /etc/profile
ADD hosts /etc/hosts
ADD set_root_pw.sh /set_root_pw.sh
ADD run.sh /run.sh
ENV JAVA_HOME /usr/lib/jdk1.7.0_55
RUN chmod +x /*.sh

EXPOSE 22 8888
CMD ["/run.sh"]</pre>
</div>
</div>
<div class="section" id="reference">
<h3>reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.widuu.com/chinese_docker/installation/opensuse.html">http://www.widuu.com/chinese_docker/installation/opensuse.html</a>
<a class="reference external" href="http://www.pchou.info/open-source/2014/03/29/docker-introduction.html">http://www.pchou.info/open-source/2014/03/29/docker-introduction.html</a></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../distribution/hadoop.html" title="Hadoop介绍及基础研究"
             >next</a> |</li>
        <li class="right" >
          <a href="../automation/energy_saving_plan.html" title="Energy Saving Plan–Valithria"
             >previous</a> |</li>
        <li><a href="../../index.html">cloudlight 1.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, knight.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>